name: Flask CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      REGISTRY: docker.io
      IMAGE_NAME: snagineni03/myflaskapp

    steps:
      # === 1️⃣ Checkout Code ===
      - name: Checkout Code
        uses: actions/checkout@v4

      # === 2️⃣ Set up Python ===
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      # === 3️⃣ Install Dependencies ===
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ansible kubernetes

      # === 4️⃣ Log in to DockerHub ===
      - name: DockerHub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # === 5️⃣ Build & Push Docker Image ===
      - name: Build Docker Image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:${{ github.run_number }} .
          docker push $REGISTRY/$IMAGE_NAME:${{ github.run_number }}

      # === 6️⃣ Configure AWS credentials ===
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # === 7️⃣ Setup kubeconfig ===
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl get nodes

      # === 8️⃣ Update Deployment YAML image tag ===
      - name: Update Deployment YAML
        run: |
          sed -i "s|image: .*|image: $REGISTRY/$IMAGE_NAME:${{ github.run_number }}|g" Ansible/k8s_deployment.yaml

      # === 9️⃣ Deploy via Ansible ===
      - name: Run Ansible Playbook
        run: |
          ansible-playbook Ansible/ansible_k8s_deploy_playbook.yaml -i localhost, --connection=local
