---
- name: Deploy Application into EKS cluster
  hosts: localhost
  connection: local
  gather_facts: no
  
  tasks:
    - name: Apply Kubernetes Deployment
      command: kubectl apply -f {{ playbook_dir }}/k8s_deployment.yaml
      register: deployment_result
    
    - name: Apply Kubernetes Service
      ansible.builtin.command: kubectl apply -f {{ playbook_dir }}/k8s_service.yaml
      register: service_result
    
    - name: Wait for LoadBalancer to be ready
      ansible.builtin.shell: |
        kubectl get svc flask-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
      register: lb_hostname
      until: lb_hostname.stdout != ""
      retries: 30
      delay: 10
    
    - name: Display LoadBalancer URL
      ansible.builtin.debug:
        msg: 
          - "Deployment complete!"
          - "LoadBalancer URL: http://{{ lb_hostname.stdout }}"
          - "Health endpoint: http://{{ lb_hostname.stdout }}/health"
